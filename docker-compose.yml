services:
  db:
    image: postgres:16
    container_name: tenorclone-db
    restart: always
    environment:
      POSTGRES_USER: app
      POSTGRES_PASSWORD: app
      POSTGRES_DB: tenorclone
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data

  db_migrate:
    image: postgres:16
    depends_on:
      - db
    environment:
      PGPASSWORD: app
    volumes:
      # choose ONE of these depending on where your sql files are:
      - ./db/migrations:/migrations:ro
      # - ./db:/migrations:ro
    entrypoint: ["/bin/bash", "-lc"]
    command: >
      set -euo pipefail;
      until pg_isready -h db -U app -d tenorclone; do sleep 1; done;

      echo 'DB ready. Contents of /migrations:';
      ls -la /migrations;

      shopt -s nullglob;
      files=(/migrations/*.sql);

      if [ "$${#files[@]}" -eq 0 ]; then
        echo 'ERROR: No .sql files found in /migrations. Fix the compose volume mount path.' >&2;
        exit 1;
      fi;

      echo 'Bootstrapping schema_migrations (000_migrations.sql)...';
      psql -h db -U app -d tenorclone -v ON_ERROR_STOP=1 -f /migrations/000_migrations.sql;

      echo 'Applying remaining migrations...';
      for f in "$${files[@]}"; do
        base="$$(basename "$$f")";
        if [ "$$base" = "000_migrations.sql" ]; then
          continue;
        fi;
        echo "Running $$f";
        psql -h db -U app -d tenorclone -v ON_ERROR_STOP=1 -f "$$f";
      done;

      echo 'Migrations complete.'

volumes:
  pgdata:
